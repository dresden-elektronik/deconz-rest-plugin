FROM --platform=$BUILDPLATFORM ubuntu:18.04 as builder

# Install required packages
RUN apt-get update \
    && apt-get install -y \
    git \
    wget \
    build-essential \
    gcc-aarch64-linux-gnu \
    g++-aarch64-linux-gnu \
    pkg-config \
    libgpiod-dev \
    libssl-dev

# Add cross-compile architecture
RUN dpkg --add-architecture arm64 \
    && echo "deb [arch=arm64] http://ports.ubuntu.com/ bionic main restricted" >> /etc/apt/sources.list.d/arm-cross-compile-sources.list \
    && echo "deb [arch=arm64] http://ports.ubuntu.com/ bionic-updates main restricted" >> /etc/apt/sources.list.d/arm-cross-compile-sources.list \
    && echo "deb [arch=arm64] http://ports.ubuntu.com/ bionic universe" >> /etc/apt/sources.list.d/arm-cross-compile-sources.list \
    && echo "deb [arch=arm64] http://ports.ubuntu.com/ bionic-updates universe" >> /etc/apt/sources.list.d/arm-cross-compile-sources.list \
    && echo "deb [arch=arm64] http://ports.ubuntu.com/ bionic multiverse" >> /etc/apt/sources.list.d/arm-cross-compile-sources.list \
    && echo "deb [arch=arm64] http://ports.ubuntu.com/ bionic-updates multiverse" >> /etc/apt/sources.list.d/arm-cross-compile-sources.list \
    && echo "deb [arch=arm64] http://ports.ubuntu.com/ bionic-backports main restricted universe multiverse" >> /etc/apt/sources.list.d/arm-cross-compile-sources.list

# Prepare toolchain file
RUN echo "set(CMAKE_SYSTEM_NAME Linux)" >> armv8.cmake \
    && echo "set(CMAKE_SYSTEM_PROCESSOR aarch64)" >> armv8.cmake \
    && echo "" >> armv8.cmake \
    && echo "set(CMAKE_C_COMPILER /usr/bin/aarch64-linux-gnu-gcc)" >> armv8.cmake \
    && echo "set(CMAKE_CXX_COMPILER /usr/bin/aarch64-linux-gnu-g++)" >> armv8.cmake \
    && echo "set(CMAKE_LINKER /usr/bin/aarch64-linux-gnu-ld)" >> armv8.cmake \
    && echo "" >> armv8.cmake \
    && echo "set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)" >> armv8.cmake \
    && echo "set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)" >> armv8.cmake \
    && echo "set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)" >> armv8.cmake \
    && echo "set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)" >> armv8.cmake

# Install required packages for target architecture
RUN apt-get update \
    || apt-get install -y \
    libqt5serialport5-dev:arm64 \
    libqt5websockets5-dev:arm64 \
    qt5-default:arm64 \
    libssl-dev:arm64 \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# We need a more current version supporting some used features
RUN wget https://cmake.org/files/v3.19/cmake-3.19.8-Linux-x86_64.tar.gz \
    && tar -xzf cmake-3.19.8-Linux-x86_64.tar.gz \
    && mv cmake-3.19.8-Linux-x86_64 cmake

# Download and compile deconz. Build debian package
RUN git clone https://github.com/dresden-elektronik/deconz.git \
    && cd deconz \
    && git submodule update --init --recursive \
    && /cmake/bin/cmake -DBUILD_CHANNEL=${BUILD_CHANNEL} -DQT_VERSION_MAJOR=5 -DCMAKE_TOOLCHAIN_FILE=/armv8.cmake -DCMAKE_BUILD_TYPE=Release -B build . \
    && /cmake/bin/cmake --build build --parallel 4 \
    && cd build \
    && /cmake/bin/cpack -G DEB -D CPACK_DEBIAN_PACKAGE_ARCHITECTURE="arm64" .

FROM scratch
COPY --from=builder /deconz/build/*.deb ./
